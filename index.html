<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Euclid - Clock</title>

    <!-- PWA: Manifest & Theme -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Euclid Clock Progressive Web App" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Euclid Clock" />

    <!-- PWA: Icons -->
    <link rel="icon" type="image/png" sizes="16x16" href="icons/16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="icons/32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="icons/96x96.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="120x120"
      href="icons/120x120.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="128x128"
      href="icons/128x128.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="144x144"
      href="icons/144x144.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="152x152"
      href="icons/152x152.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="180x180"
      href="icons/180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="icons/192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="384x384"
      href="icons/384x384.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="icons/512x512.png"
    />

    <!-- Apple Touch (iOS) -->
    <link rel="apple-touch-icon" sizes="120x120" href="icons/120x120.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="icons/152x152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="icons/180x180.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Euclid Clock" />

    <!-- Windows -->
    <meta name="msapplication-TileColor" content="#000000" />
    <meta name="msapplication-TileImage" content="icons/144x144.png" />

    <!-- Service Worker Registration -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker.register("service-worker.js");
        });
      }
    </script>

    <style>
      @font-face {
        font-family: "SF Pro Display";
        src: url("SF-Pro-Display-Light.otf") format("opentype");
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        user-select: none;
      }

      body {
        background-color: black;
        color: white;
        display: flex;
        align-items: center;
        justify-content: right;
        height: 100vh;
        overflow: hidden;
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      body.inverted {
        background-color: white;
        color: black;
      }

      #clock {
        font-family: "SF Pro Display", sans-serif;
        display: flex;
        align-items: center;
        line-height: 80%;
        text-align: center;
      }

      #minute_part_2 {
        display: flex;
        flex-direction: column;
        margin-left: -320px;
      }

      .digit_container {
        display: flex;
        flex-direction: row;
      }

      .digit {
        width: 0.65em;
      }
    </style>
  </head>

  <body>
    <div id="clock">
      <div id="hours"></div>
      <div id="minute_part_1"></div>
      <div id="minute_part_2"></div>
    </div>

    <script>
      let BUFFER_SIZE = 19;
      let fontSize = 750;

      const hoursEl = document.getElementById("hours");
      const minutePart1El = document.getElementById("minute_part_1");
      const minutePart2El = document.getElementById("minute_part_2");

      function createDigit(char) {
        const div = document.createElement("div");
        div.className = "digit";
        div.textContent = char;
        return div;
      }

      function setDigitRow(parent, text) {
        parent.innerHTML = "";

        const container = document.createElement("div");
        container.className = "digit_container";

        for (const char of text) {
          container.appendChild(createDigit(char));
        }

        parent.appendChild(container);
      }

      function initializeMinuteBuffer() {
        for (let i = 0; i < BUFFER_SIZE; i++) {
          const div = document.createElement("div");
          div.id = `minute_buffer_${i}`;
          minutePart2El.appendChild(div);
        }
      }

      function updateClock() {
        const now = new Date();

        const hours = now.getHours() % 12 || 12;
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();

        // Special padding adjustment
        hoursEl.style.paddingRight = minutes === 19 ? "70px" : "0px";

        const hoursStr = hours.toString();
        const minutesStr = minutes.toString().padStart(2, "0");

        hoursEl.textContent = `${hoursStr}:`;
        setDigitRow(minutePart1El, minutesStr[0]);

        for (let i = 0; i < BUFFER_SIZE; i++) {
          const bufferEl = document.getElementById(`minute_buffer_${i}`);

          const ithMinute =
            (minutes + i - Math.floor(BUFFER_SIZE / 2) + 60) % 60;
          const minuteText = ithMinute.toString().padStart(2, "0");

          let content;

          if (minutes % 10 === 0) {
            content = ithMinute % 10 === 9 ? minuteText : "⠀" + minuteText[1];
          } else if (minutes % 10 === 1 && ithMinute % 10 === 0) {
            content = "⠀" + minuteText[1];
          } else {
            content = ithMinute % 10 === 0 ? minuteText : "⠀" + minuteText[1];
          }

          setDigitRow(bufferEl, content);
        }

        const b = (fontSize / 600) * 16;
        const offset = 0 - seconds * b;

        minutePart2El.style.marginTop = `${offset}px`;
        minutePart1El.style.marginTop =
          minutes % 10 === 9 ? `${offset}px` : "0px";
      }

      function onInitialize() {
        const resizeObserver = new ResizeObserver(() => {
          console.log("resize observed", window.innerWidth);
          fontSize = (window.innerWidth * 750) / 1952;
          document.body.style.fontSize = `${fontSize}px`;
          document.getElementById("minute_part_2").style.marginLeft = `-${
            320 * (fontSize / 500)
          }px`;
          initializeMinuteBuffer();
          updateClock();
        });

        resizeObserver.observe(document.body);
        initializeMinuteBuffer();
        updateClock();
      }

      onInitialize();

      setInterval(updateClock, 1000);

      document.body.addEventListener("click", () => {
        document.body.classList.toggle("inverted");
      });
    </script>
  </body>
</html>
